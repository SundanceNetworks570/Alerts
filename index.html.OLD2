<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Security Alerts Dashboard (Last 3 Weeks)</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--muted:#94a3b8;--text:#e2e8f0;}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.75) 60%, rgba(11,18,32,0));backdrop-filter:saturate(140%) blur(6px);}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-size:20px;font-weight:700;margin-right:auto}
    .btn{border:1px solid #2b3a55;background:#1a2340;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#486089}
    .src{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px dashed #2b3a55;border-radius:999px;color:var(--muted);font-size:12px}
    .card{background:var(--card);border:1px solid #1f2c47;border-radius:14px;padding:14px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-3{grid-column:span 3}.col-9{grid-column:span 9}
    @media (max-width:980px){.col-3,.col-9{grid-column:1/-1}}
    input[type="search"], select, textarea{background:#0e1628;border:1px solid #30415f;color:var(--text);padding:10px 12px;border-radius:10px;min-width:220px}
    textarea{width:100%;min-height:140px}
    .hint{color:var(--muted);font-size:12px}
    .list{display:grid;gap:10px;margin-top:12px}
    .item{display:grid;grid-template-columns: 120px 1fr;gap:14px;align-items:baseline;border:1px solid #1f2c47;border-radius:12px;padding:12px;background:#0f172a}
    .date{color:#cbd5e1;font-weight:700}
    .srcTag{font-size:12px;color:#a3b5d6;border:1px solid #2a3a5a;padding:3px 8px;border-radius:999px}
    .item a{color:#93c5fd;text-decoration:none}.item a:hover{text-decoration:underline}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .count{color:var(--muted)}
    details > summary{cursor:pointer;color:#a5b4fc}
    footer{color:#64748b;margin:40px 0 20px}
    .empty{color:#9aa7bd;text-align:center;padding:24px;border:1px dashed #314564;border-radius:12px}
    @media print{header,.no-print{display:none!important}body{background:#fff;color:#000}.item{border-color:#ddd;background:#fff}a{color:#000}}
  </style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="title">Security Alerts (Last 3 Weeks)</div>
      <input id="search" type="search" placeholder="Filter by keyword… (e.g., CVE, Exchange)" />
      <select id="dateRange">
        <option value="21">Past 3 weeks</option>
        <option value="14">Past 2 weeks</option>
        <option value="7">Past week</option>
        <option value="3">Past 3 days</option>
      </select>
      <button class="btn" id="refreshBtn" title="Fetch latest now">Refresh</button>
      <button class="btn" onclick="window.print()" title="Print or Save as PDF">Print / Save PDF</button>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="col-3 card">
        <h3 style="margin:0 0 8px">Sources</h3>
        <div id="sourceList" style="display:grid;gap:8px;margin:12px 0"></div>

        <details class="no-print" open>
          <summary>Customize feeds</summary>
          <div class="hint" style="margin:10px 0">Paste RSS/Atom feed URLs (one per line). Defaults are already loaded. (Tip: if your network blocks proxies, switch to a Cloudflare Worker and set <code>WORKER_URL</code> below.)</div>
          <textarea id="feedsInput"></textarea>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" id="saveFeeds">Use These Feeds (this session)</button>
            <button class="btn" id="resetFeeds">Reset to Defaults</button>
          </div>
        </details>

        <div style="margin-top:12px" class="hint">Showing <span id="count" class="count">0</span> items</div>
      </section>

      <section class="col-9">
        <div id="status" class="hint"></div>
        <div id="list" class="list"></div>
      </section>
    </div>

    <footer>
      <div>Tip: Click a headline to open the original alert. Use the search box to filter. Use the Print button to export to PDF.</div>
    </footer>
  </main>

<script>
// ====================== CONFIG ======================
// Optional: if you create a Cloudflare Worker per my instructions,
// set this to your worker endpoint (e.g., "https://security-alerts.yourname.workers.dev/").
// Leave as empty string to use client-side proxy fetching.
const WORKER_URL = "";

// Default security-focused feeds:
const DEFAULT_FEEDS = [
  { name: "MSRC Security Updates", url: "https://msrc.microsoft.com/update-guide/rss" },
  { name: "BleepingComputer", url: "https://www.bleepingcomputer.com/feed/" },
  { name: "Windows Release Health", url: "https://learn.microsoft.com/en-us/feed/rss/windows/release-health" }
];

// No storage dependency. Session-only customization:
let CURRENT_FEEDS = [...DEFAULT_FEEDS];

// =================== UTILITIES ===================
const dayMs = 24*60*60*1000;
function withinDays(date, days){
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // midnight today
  const cutoff = new Date(start.getTime() - (days*dayMs));
  return date >= cutoff && date <= now;
}
function fmtDate(d){
  return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function stripTags(html){
  const t = document.createElement('div'); t.innerHTML = html; return t.textContent || '';
}
function truncate(s, n){ return s.length>n ? s.slice(0,n-1)+'…' : s; }
function normalize(s){ return (s||'').toLowerCase(); }

// Parse RSS/Atom
function parseFeed(xmlText, sourceName){
  const doc = new DOMParser().parseFromString(xmlText, "text/xml");
  if(doc.querySelector("parsererror")) throw new Error("Invalid XML for "+sourceName);
  const items = [];
  doc.querySelectorAll("channel > item").forEach(item => {
    const title = item.querySelector("title")?.textContent?.trim() || "(no title)";
    const link = item.querySelector("link")?.textContent?.trim() || item.querySelector("guid")?.textContent?.trim() || "";
    const dateStr = item.querySelector("pubDate")?.textContent || item.querySelector("dc\:date")?.textContent || "";
    const pub = dateStr ? new Date(dateStr) : new Date();
    const desc = item.querySelector("description")?.textContent || "";
    items.push({title, link, pub, source: sourceName, description: desc});
  });
  doc.querySelectorAll("feed > entry").forEach(entry => {
    const title = entry.querySelector("title")?.textContent?.trim() || "(no title)";
    const linkEl = entry.querySelector("link[rel='alternate']") || entry.querySelector("link[href]");
    const link = linkEl?.getAttribute("href") || "";
    const dateStr = entry.querySelector("updated")?.textContent || entry.querySelector("published")?.textContent || "";
    const pub = dateStr ? new Date(dateStr) : new Date();
    const desc = entry.querySelector("summary")?.textContent || entry.querySelector("content")?.textContent || "";
    items.push({title, link, pub, source: sourceName, description: desc});
  });
  return items;
}

// =================== FETCH LAYER ===================
const FETCH_TIMEOUT_MS = 9000;
function fetchWithTimeout(resource, options = {}, ms = FETCH_TIMEOUT_MS){
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), ms);
  return fetch(resource, { ...options, signal: controller.signal }).finally(() => clearTimeout(id));
}

// Multi-proxy fetch sequence (works well on GitHub Pages)
async function fetchFeedClientSide(url){
  const targets = [
    // r.jina.ai (very CORS-friendly). It expects http scheme in the path:
    (u)=>'https://r.jina.ai/http://' + u.replace(/^https?:\/\//,''),
    // AllOrigins raw
    (u)=>'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
    // isomorphic-git CORS proxy
    (u)=>'https://cors.isomorphic-git.org/' + u
  ];
  let lastErr;
  for(const make of targets){
    const proxyUrl = make(url);
    try{
      const res = await fetchWithTimeout(proxyUrl, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      if(text && text.length > 50) return text;
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('All proxies failed');
}

// If a Worker is configured, fetch once and parse each returned xml
async function fetchViaWorker(){
  const res = await fetchWithTimeout(WORKER_URL, { cache:'no-store' });
  if(!res.ok) throw new Error('Worker HTTP '+res.status);
  const arr = await res.json(); // [{url, xml} or {url, error}]
  const map = new Map();
  for(const row of arr){
    map.set(row.url, row);
  }
  return map;
}

// =================== RENDER ===================
function renderSources(feeds){
  const wrap = document.getElementById('sourceList'); wrap.innerHTML='';
  feeds.forEach(f => {
    const el = document.createElement('div'); el.className='src';
    el.textContent = f.name; wrap.appendChild(el);
  });
  document.getElementById('feedsInput').value = feeds.map(f => `${f.name} | ${f.url}`).join('\n');
}
function renderList(items){
  const list = document.getElementById('list'); const count = document.getElementById('count');
  list.innerHTML='';
  if(!items.length){
    list.innerHTML = '<div class="empty">No items in the selected window. Try expanding the date range or hit Refresh.</div>';
    count.textContent = '0'; return;
  }
  items.forEach(it => {
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class="date">${fmtDate(it.pub)}</div>
      <div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <a href="${it.link}" target="_blank" rel="noopener noreferrer">${it.title}</a>
          <span class="srcTag">${it.source}</span>
        </div>
        ${it.description ? `<div class="hint" style="margin-top:6px">${truncate(stripTags(it.description), 240)}</div>` : ''}
      </div>`;
    list.appendChild(row);
  });
  count.textContent = String(items.length);
}

// =================== MAIN ===================
async function loadAndRender(){
  const status = document.getElementById('status');
  status.textContent = 'Fetching feeds…';
  const feeds = CURRENT_FEEDS;
  renderSources(feeds);

  const days = parseInt(document.getElementById('dateRange').value, 10) || 21;
  const query = normalize(document.getElementById('search').value);
  const allItems = [];
  const errors = [];

  try{
    if(WORKER_URL){
      // Use server-side fetcher
      const map = await fetchViaWorker();
      for(const f of feeds){
        const row = map.get(f.url);
        if(row && row.xml){
          try{
            const items = parseFeed(row.xml, f.name);
            for(const it of items){
              if(!it.pub || isNaN(it.pub.getTime())) continue;
              if(!withinDays(it.pub, days)) continue;
              if(query){
                const hay = `${it.title} ${it.source} ${it.description}`.toLowerCase();
                if(!hay.includes(query)) continue;
              }
              allItems.push(it);
            }
          }catch(e){ errors.push(f.name); }
        }else{
          errors.push(f.name);
        }
      }
    }else{
      // Client-side parallel fetching with timeouts and fallbacks
      const results = await Promise.allSettled(
        feeds.map(async (f) => {
          try{
            const xml = await fetchFeedClientSide(f.url);
            const items = parseFeed(xml, f.name);
            return { f, items };
          }catch(e){ return { f, error: e }; }
        })
      );
      for(const r of results){
        if(r.status === 'fulfilled' && r.value.items){
          const { f, items } = r.value;
          for(const it of items){
            if(!it.pub || isNaN(it.pub.getTime())) continue;
            if(!withinDays(it.pub, days)) continue;
            if(query){
              const hay = `${it.title} ${it.source} ${it.description}`.toLowerCase();
              if(!hay.includes(query)) continue;
            }
            allItems.push(it);
          }
        }else{
          errors.push(r.value?.f?.name || 'Unknown');
        }
      }
    }
  }catch(e){
    errors.push('General load error: '+ e.message);
  }

  allItems.sort((a,b)=> b.pub - a.pub);
  renderList(allItems);
  if(errors.length){
    status.innerHTML = `Loaded with warnings: Failed to fetch <b>${errors.join(', ')}</b>.`;
  }else{
    status.textContent = `Loaded ${allItems.length} item(s).`;
  }
}

// Events
document.getElementById('refreshBtn').addEventListener('click', loadAndRender);
document.getElementById('dateRange').addEventListener('change', loadAndRender);
document.getElementById('search').addEventListener('input', () => loadAndRender());
document.getElementById('saveFeeds').addEventListener('click', () => {
  const lines = document.getElementById('feedsInput').value.split(/\n+/).map(l=>l.trim()).filter(Boolean);
  const parsed = lines.map(l => {
    const parts = l.split('|');
    if(parts.length >= 2){
      return { name: parts[0].trim(), url: parts.slice(1).join('|').trim() };
    } else {
      try{ const u = new URL(l); return { name: u.hostname, url: l }; }
      catch{ return null }
    }
  }).filter(Boolean);
  CURRENT_FEEDS = parsed.length ? parsed : [...DEFAULT_FEEDS];
  renderSources(CURRENT_FEEDS);
  loadAndRender();
});
document.getElementById('resetFeeds').addEventListener('click', () => {
  CURRENT_FEEDS = [...DEFAULT_FEEDS];
  renderSources(CURRENT_FEEDS);
  loadAndRender();
});

// Initial load
renderSources(CURRENT_FEEDS);
loadAndRender();
</script>
</body>
</html>
